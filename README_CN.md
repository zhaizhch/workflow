# Work-Flow

Work-Flow æ˜¯ä¸€ä¸ªæ„å»ºåœ¨ Kubernetes ä¹‹ä¸Šçš„é«˜æ€§èƒ½ã€äº‘åŸç”Ÿå·¥ä½œæµå¼•æ“ï¼Œä¸“æ³¨äºæ‰¹å¤„ç†ä»»åŠ¡ã€AI è®­ç»ƒä»»åŠ¡ï¼ˆæ·±åº¦å­¦ä¹ ï¼‰ä»¥åŠå¤æ‚æ•°æ®æµæ°´çº¿çš„ç¼–æ’ã€‚å®ƒå…è®¸ç”¨æˆ·é€šè¿‡ç›´è§‚çš„ YAML é…ç½®æ¥ç®¡ç†å¤æ‚çš„ä»»åŠ¡ä¾èµ–å…³ç³»å’Œç”Ÿå‘½å‘¨æœŸäº‹ä»¶ã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **ğŸŒˆ å¤šå·¥ä½œè´Ÿè½½æ”¯æŒ**:
  - **Batch Job**: æ·±åº¦é›†æˆé«˜æ€§èƒ½æ‰¹å¤„ç†ä»»åŠ¡å’Œé€šç”¨ä½œä¸šã€‚
  - **AI è®­ç»ƒæ”¯æŒ**: åŸç”Ÿæ”¯æŒ Kubeflow æ¡†æ¶ï¼ˆPyTorchJob, MPIJob, PaddleJob ç­‰ï¼‰ã€‚
  - **K8s åŸç”Ÿèµ„æº**: æ”¯æŒ Deployment ç­‰æ ‡å‡†èµ„æºåŠè‡ªå®šä¹‰ CRDã€‚

- **ğŸ›  é«˜çº§æµç¨‹æ§åˆ¶**:
  - **Probe (æ¢æµ‹å™¨)**: åŸºäº HTTPã€TCP æˆ–ä»»åŠ¡çŠ¶æ€çš„åŠ¨æ€æµæ§ã€‚æ”¯æŒå¤šå‰¯æœ¬åŒæ­¥æ¢æµ‹ã€‚
  - **Parallel For (å¹¶è¡Œå¾ªç¯)**: æ”¯æŒä»»åŠ¡å‰¯æœ¬çš„å¹¶è¡Œæ‰§è¡Œï¼Œå¹¶å…·å¤‡ç´¢å¼•æ³¨å…¥èƒ½åŠ›ã€‚
  - **Retry (è‡ªåŠ¨é‡è¯•)**: çµæ´»çš„ä»»åŠ¡çº§é‡è¯•ç­–ç•¥åŠæŒ‡æ•°é€€é¿ã€‚

- **ğŸ­ åŠ¨æ€é…ç½® (Patch)**: åœ¨å¼•ç”¨æ¨¡æ¿æ—¶é€šè¿‡ **Patch** åŠ¨æ€æ³¨å…¥é…ç½®ï¼Œå®ç°æ¨¡æ¿çš„é«˜åº¦å¤ç”¨ã€‚

- **ğŸ›¡ å¥å£®æ€§**: å†…ç½®å¹‚ç­‰æ€§ç®¡ç†ã€å®Œå–„çš„çŠ¶æ€æœºæ„ŸçŸ¥ä»¥åŠè‡ªåŠ¨æ•…éšœæ¢å¤ã€‚

## ğŸ— æ¶æ„è®¾è®¡ä¸é«˜æ€§èƒ½ç‰¹æ€§

Work-Flow ä¸“ä¸ºä¼ä¸šçº§ç¨³å®šæ€§å’Œè¶…å¤§è§„æ¨¡ååé‡è€Œè®¾è®¡ã€‚

### âš¡ å·…å³°çº§çš„å¹¶å‘å¤„ç† (High Concurrency)

æ§åˆ¶å™¨é‡‡ç”¨äº† **åˆ†ç‰‡å·¥ä½œé˜Ÿåˆ—æ¶æ„ (Sharded Workqueue Architecture)**ï¼Œä»¥æœ€å¤§åŒ– CPU åˆ©ç”¨ç‡å¹¶æ¶ˆé™¤é”ç«äº‰ï¼š

- **æ°´å¹³åˆ†ç‰‡**ï¼šä»»åŠ¡æ ¹æ® `Namespace/Name` è¿›è¡Œå“ˆå¸Œï¼Œå¹¶å‡åŒ€åˆ†å¸ƒåˆ°å¤šä¸ªå·¥ä½œçº¿ç¨‹ã€‚
- **é…ç½®åŒ–å¹¶è¡Œ**ï¼šé€šè¿‡è°ƒæ•´ `--workers` å¯åŠ¨å‚æ•°ï¼Œå³å¯çµæ´»æ‰©å±•å¤„ç†èƒ½åŠ›ã€‚

### ğŸ›¡ é«˜å¯ç”¨æ€§ä¿éšœ (High Availability)

ä¸ºå…³é”®ä»»åŠ¡æµç¨‹æä¾›æœ‰åŠ›æ”¯æ’‘ï¼š

- **Leader Election**ï¼šæ”¯æŒå¤šå‰¯æœ¬éƒ¨ç½²ï¼Œé€šè¿‡ä¸»å¤‡é€‰ä¸¾æœºåˆ¶æ¶ˆé™¤å•ç‚¹æ•…éšœã€‚
- **çŠ¶æ€éŸ§æ€§**ï¼šåœ¨å‘ç”Ÿæ•…éšœåˆ‡æ¢åï¼Œç³»ç»Ÿèƒ½ä»æœ€ååŒæ­¥çš„çŠ¶æ€å¹³æ»‘æ¢å¤æ‰§è¡Œæµã€‚

```mermaid
graph TD
    A[API Server] --> B{Work-Flow Leader}
    B --> Q1[å·¥ä½œé˜Ÿåˆ— 0]
    B --> Q2[å·¥ä½œé˜Ÿåˆ— 1]
    B --> Q3[å·¥ä½œé˜Ÿåˆ— N]
    Q1 --> W1[Worker A]
    Q2 --> W2[Worker B]
    Q3 --> W3[Worker C]
    W1 --> J1(Volcano ä»»åŠ¡)
    W2 --> J2(Kubeflow ä»»åŠ¡)
    W3 --> J3(K8s åŸç”Ÿä»»åŠ¡)
```

## ğŸ›  å®‰è£…ä¸éƒ¨ç½²

1. **å®‰è£… CRD**:

   ```bash
   make install-crds
   ```

2. **éƒ¨ç½²æ§åˆ¶å™¨ä¸ Webhook**:

   ```bash
   kubectl apply -f installer/controller/
   ```

## ğŸ“– å¿«é€Ÿå¼€å§‹

### åŸºç¡€ DAG ç¤ºä¾‹

éƒ¨ç½²ä¸€ä¸ªç®€å•çš„ä»»åŠ¡æµå›¾ï¼š

```bash
make deploy-example
```

### é«˜çº§è¿›é˜¶æ¼”ç¤º (Premium Advanced Demo)

æ¢ç´¢ `Probe`ã€`For` å¾ªç¯ä»¥åŠæ··åˆ AI è®­ç»ƒä»»åŠ¡ç­‰é«˜çº§ç‰¹æ€§ï¼š

```bash
make deploy-advanced-example
```

## ğŸ— å¼€å‘æŒ‡å—

- **æ„å»ºäºŒè¿›åˆ¶**: `make build`
- **è¿è¡Œå•å…ƒæµ‹è¯•**: `make test`
- **æ„å»ºå¹¶æ¨é€é•œåƒ**: `make images` (åŒæ—¶æ„å»ºæ§åˆ¶å™¨å’Œ Admission é•œåƒ)

## ğŸ“ é¡¹ç›®ç»“æ„

- `pkg/apis`: API å®šä¹‰ä¸ CRD Schemaã€‚
- `pkg/controllers`: é‡æ„åçš„æ¨¡å—åŒ–æ§åˆ¶å™¨é€»è¾‘ï¼ˆä¾èµ–ç®¡ç†ã€çŠ¶æ€èšåˆã€ä»»åŠ¡æ§åˆ¶ï¼‰ã€‚
- `pkg/webhooks`: å‡†å…¥æ§åˆ¶é€»è¾‘ï¼Œè´Ÿè´£å·¥ä½œæµçš„éªŒè¯ä¸å˜æ›´ã€‚
- `installer`: ç”Ÿäº§çº§éƒ¨ç½²é…ç½®æ¸…å•ã€‚
- `examples`: ä¸°å¯Œçš„ YAML é…ç½®æ¨¡å¼ç¤ºä¾‹ã€‚

## ğŸ“„ è®¸å¯è¯

Copyright 2026 zhaizhicheng. é‡‡ç”¨ Apache License, Version 2.0 è®¸å¯è¯ã€‚
